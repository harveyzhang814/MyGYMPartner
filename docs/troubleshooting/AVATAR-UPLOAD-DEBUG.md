# 头像上传功能调试指南

## 问题现象
用户反映"显示上传头像失败"

## 已完成的修复

### 1. ✅ 环境变量配置
- 添加了 `AVATAR_UPLOAD_ENABLED=true` 到 `backend/.env`
- 重启后端服务以加载新配置

### 2. ✅ 前端URL配置
- 修改上传URL从绝对路径改为相对路径：`/profile/upload-avatar`
- 让axios自动处理baseURL

### 3. ✅ 错误处理增强
- 添加了详细的控制台日志
- 增强了错误消息显示
- 添加了调试信息输出

## 调试步骤

### 1. 检查服务状态
```bash
# 检查后端服务
curl http://localhost:3001/health

# 检查前端服务
curl http://localhost:5173
```

### 2. 检查环境变量
```bash
# 确认头像上传已启用
grep AVATAR_UPLOAD_ENABLED backend/.env
```

### 3. 检查目录权限
```bash
# 检查uploads目录
ls -la backend/uploads/avatars/
```

### 4. 浏览器调试
1. 打开浏览器开发者工具（F12）
2. 进入个人中心页面
3. 点击"更换头像"按钮
4. 选择图片文件
5. 查看控制台日志
6. 查看网络请求标签页

### 5. 使用测试页面
打开 `test-avatar-upload-detailed.html` 进行独立测试

## 可能的问题和解决方案

### 问题1：认证失败
**现象**：返回401错误
**解决**：确保用户已登录，token有效

### 问题2：CORS错误
**现象**：浏览器控制台显示CORS错误
**解决**：检查后端CORS配置

### 问题3：文件大小超限
**现象**：上传被阻止
**解决**：选择小于5MB的图片文件

### 问题4：文件类型错误
**现象**：只允许图片文件
**解决**：选择JPG、PNG等图片格式

### 问题5：网络请求失败
**现象**：请求无法发送
**解决**：检查网络连接和后端服务状态

## 测试用例

### 正常流程测试
1. 登录应用
2. 进入个人中心
3. 点击"更换头像"
4. 选择一张小于5MB的图片
5. 确认上传成功

### 异常流程测试
1. 未登录状态下尝试上传
2. 选择非图片文件
3. 选择超大文件（>5MB）
4. 网络断开状态下上传

## 日志分析

### 后端日志
查看nodemon输出，寻找：
- 文件上传请求
- 错误信息
- 数据库操作

### 前端日志
查看浏览器控制台：
- 上传状态变化
- 网络请求详情
- 错误信息

## 常见错误信息

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| "Access denied. No token provided." | 未登录或token无效 | 重新登录 |
| "头像上传功能暂未启用" | 生产环境或配置错误 | 检查环境变量 |
| "只允许上传图片文件" | 文件类型错误 | 选择图片文件 |
| "图片大小不能超过5MB" | 文件过大 | 压缩图片或选择更小的文件 |
| "上传失败" | 服务器错误 | 检查后端日志 |

## 下一步调试

如果问题仍然存在，请：

1. **检查浏览器控制台**：查看详细的错误信息
2. **检查网络请求**：确认请求是否发送成功
3. **检查后端日志**：查看服务器端错误
4. **使用测试页面**：独立测试上传功能
5. **检查文件权限**：确保uploads目录可写

## 联系支持

如果问题无法解决，请提供：
- 浏览器控制台截图
- 网络请求详情
- 后端日志输出
- 复现步骤
